services:
  app_db:
    image: postgres:16-alpine
    container_name: app_db
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    volumes:
      - app_db_data:/var/lib/postgresql/data
    networks: [app_net]

  backend:
    # 使用 Docker Hub 上的后端镜像；通过 TAG 环境变量指定版本（默认 latest）
    image: candy0327/north-wind-test:backend-${TAG:-latest}
    container_name: backend
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-prod}
      SECRET_KEY: ${SECRET_KEY:-change-me}
      JWT_SECRET: ${JWT_SECRET:-change-me-too}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-change-me-encrypt}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://app:app@app_db:5432/appdb}
      ALLOWED_CORS_ORIGINS: ${ALLOWED_CORS_ORIGINS:-["http://localhost:3000"]}
      DEFAULT_TIMEOUT_SECONDS: ${DEFAULT_TIMEOUT_SECONDS:-6}
      DEFAULT_MAX_ROWS: ${DEFAULT_MAX_ROWS:-1000}
      DEFAULT_CONCURRENCY_LIMIT: ${DEFAULT_CONCURRENCY_LIMIT:-5}
      DEFAULT_RATE_LIMIT_PER_MINUTE: ${DEFAULT_RATE_LIMIT_PER_MINUTE:-30}
      # 指定 Northwind 脚本路径（与下方卷挂载一致）
      NORTHWIND_PG_SCRIPT_PATH: /app/infrastructure/sql/northwind_pg.sql
    volumes:
      # 将仓库内的 SQL 脚本挂载到镜像内，避免“未找到DDL文件”
      - ./infrastructure/sql:/app/infrastructure/sql:ro
    ports:
      - "10000:10000"
    depends_on: [app_db]
    networks: [app_net]

  frontend:
    # 使用 Docker Hub 上的前端镜像；通过 TAG 环境变量指定版本（默认 latest）
    image: candy0327/north-wind-test:frontend-${TAG:-latest}
    container_name: frontend
    environment:
      # 浏览器端始终同源访问 /api
      NEXT_PUBLIC_API_BASE_URL: /api
      # Next 服务器将 /api 代理到后端容器 backend:10000/api
      NEXT_API_PROXY_TARGET: http://backend:10000/api
      NODE_ENV: production
    volumes:
      # 确保前端容器可读取 DDL（页面预览与静态下载均可）
      - ./infrastructure/sql:/app/infrastructure/sql:ro
      - ./infrastructure/sql:/app/frontend/public/sql:ro
    ports:
      - "3000:3000"
    depends_on: [backend]
    networks: [app_net]

volumes:
  app_db_data:

networks:
  app_net:
